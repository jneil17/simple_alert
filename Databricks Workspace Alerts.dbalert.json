{
  "custom_summary": "Alert \"{{ALERT_NAME}}\" - Status: {{ALERT_STATUS}}",
  "evaluation": {
    "source": {
      "name": "total_usd",
      "display": "total_usd",
      "aggregation": "MAX"
    },
    "comparison_operator": "GREATER_THAN",
    "threshold": {
      "value": {
        "double_value": 10.0
      }
    },
    "empty_result_state": "OK",
    "notification": {
      "retrigger_seconds": 1
    }
  },
  "schedule": {
    "quartz_cron_schedule": "22 0 8/12 * * ?",
    "timezone_id": "America/New_York"
  },
  "query_lines": [
    "with workspace as (",
    "  select distinct workspace_id",
    "  from system.billing.usage",
    "),",
    "-- filter usage for last 7 days",
    "usage_with_ws_filtered_by_date as (",
    "  select",
    "    concat('id: ', u.workspace_id) as workspace,",
    "    u.*",
    "  from system.billing.usage as u",
    "  left join workspace",
    "    on u.workspace_id = workspace.workspace_id",
    "  where u.usage_date between current_date() - interval 3 day and current_date()",
    "),",
    "-- join with prices in USD",
    "prices as (",
    "  select coalesce(price_end_time, date_add(current_date(), 1)) as coalesced_price_end_time, *",
    "  from system.billing.list_prices",
    "  where currency_code = 'USD'",
    "),",
    "list_priced_usd as (",
    "  select",
    "    workspace,",
    "    u.workspace_id,",
    "    u.sku_name,",
    "    u.usage_date,",
    "    coalesce(u.usage_quantity * p.pricing.effective_list.default, 0) as usage_usd",
    "  from usage_with_ws_filtered_by_date as u",
    "  left join prices as p",
    "    on u.sku_name = p.sku_name",
    "    and u.usage_unit = p.usage_unit",
    "    and (u.usage_end_time between p.price_start_time and p.coalesced_price_end_time)",
    "),",
    "daily_workspace_sku as (",
    "  select",
    "    usage_date,",
    "    workspace,",
    "    sku_name,",
    "    sum(usage_usd) as total_usd_spend",
    "  from list_priced_usd",
    "  group by usage_date, workspace, sku_name",
    "  having sum(usage_usd) > 5",
    "),",
    "daily_workspace_total as (",
    "  select",
    "    usage_date,",
    "    workspace,",
    "    sum(total_usd_spend) as workspace_total_usd",
    "  from daily_workspace_sku",
    "  group by usage_date, workspace",
    "),",
    "ranked_skus as (",
    "  select",
    "    dws.usage_date,",
    "    dws.workspace,",
    "    dws.sku_name,",
    "    dws.total_usd_spend,",
    "    dwt.workspace_total_usd,",
    "    dws.total_usd_spend / dwt.workspace_total_usd as percentage_usage,",
    "    row_number() over (partition by dws.usage_date, dws.workspace order by dws.total_usd_spend desc) as rn",
    "  from daily_workspace_sku dws",
    "  join daily_workspace_total dwt",
    "    on dws.usage_date = dwt.usage_date and dws.workspace = dwt.workspace",
    ")",
    "select",
    "  usage_date,",
    "  workspace,",
    "  concat(sku_name, ' | ', round(percentage_usage * 100, 0), '%') as top_sku_percentage_usage,",
    "  round(workspace_total_usd,0) as total_usd",
    "from ranked_skus",
    "where rn = 1",
    "order by usage_date desc, workspace"
  ],
  "custom_description_lines": [
    "<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; max-width: 700px; margin: 0 auto; background-color: #ffffff;\">",
    "  <div style=\"background-color: #FF3621; color: white; padding: 28px 24px;\">",
    "    <h2 style=\"margin: 0; font-size: 24px; font-weight: 600; letter-spacing: -0.5px;\">⚠️ Cost Threshold Alert Triggered</h2>",
    "  </div>",
    "  ",
    "  <div style=\"background-color: #F9F7F4; padding: 28px 24px;\">",
    "    <h3 style=\"color: #1B3139; margin: 0 0 20px 0; font-size: 16px; font-weight: 600; letter-spacing: -0.3px;\">Alert Details</h3>",
    "    <table style=\"width: 100%; border-collapse: collapse; background-color: white; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);\">",
    "      <tr>",
    "        <td style=\"padding: 14px 20px; font-weight: 600; width: 35%; border-bottom: 1px solid #F9F7F4; color: #1B3139; font-size: 14px;\">Alert Name</td>",
    "        <td style=\"padding: 14px 20px; border-bottom: 1px solid #F9F7F4; color: #1B3139;\">{{ALERT_NAME}}</td>",
    "      </tr>",
    "      <tr>",
    "        <td style=\"padding: 14px 20px; font-weight: 600; border-bottom: 1px solid #F9F7F4; color: #1B3139; font-size: 14px;\">Status</td>",
    "        <td style=\"padding: 14px 20px; border-bottom: 1px solid #F9F7F4;\">",
    "          <span style=\"color: #FF3621; font-weight: 700; font-size: 16px;\">{{ALERT_STATUS}}</span>",
    "        </td>",
    "      </tr>",
    "      <tr>",
    "        <td style=\"padding: 14px 20px; font-weight: 600; border-bottom: 1px solid #F9F7F4; color: #1B3139; font-size: 14px;\">Condition</td>",
    "        <td style=\"padding: 14px 20px; border-bottom: 1px solid #F9F7F4; color: #1B3139; font-family: 'Courier New', monospace; font-size: 13px;\">{{ALERT_COLUMN}} {{ALERT_CONDITION}} ${{ALERT_THRESHOLD}}</td>",
    "      </tr>",
    "      <tr>",
    "        <td style=\"padding: 14px 20px; font-weight: 600; color: #1B3139; font-size: 14px;\">Total Dollars Spent</td>",
    "        <td style=\"padding: 14px 20px;\">",
    "          <span style=\"font-weight: 700; font-size: 26px; color: #FF3621;\">${{QUERY_RESULT_VALUE}}</span>",
    "        </td>",
    "      </tr>",
    "    </table>",
    "  </div>",
    "  ",
    "  <div style=\"padding: 28px 24px; background-color: white;\">",
    "    <h3 style=\"color: #1B3139; margin: 0 0 8px 0; font-size: 16px; font-weight: 600; letter-spacing: -0.3px;\">Cost Breakdown by Workspace (Last 3 Days)</h3>",
    "    <p style=\"margin: 0 0 20px 0; color: #6B7280; font-size: 13px;\">Showing top SKU per workspace per day (SKUs with spend &gt; $5)</p>",
    "    <div style=\"overflow-x: auto; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);\">",
    "      <table style=\"width: 100%; border-collapse: collapse; background-color: white; font-size: 13px;\">",
    "        <thead>",
    "          <tr style=\"background-color: #1B3139; color: white;\">",
    "            <th style=\"padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;\">Usage Date</th>",
    "            <th style=\"padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;\">Workspace</th>",
    "            <th style=\"padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;\">Top SKU</th>",
    "            <th style=\"padding: 12px 16px; text-align: right; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;\">Daily Cost</th>",
    "          </tr>",
    "        </thead>",
    "        <tbody>",
    "          {{QUERY_RESULT_TABLE}}",
    "        </tbody>",
    "      </table>",
    "    </div>",
    "    <p style=\"margin: 16px 0 0 0; color: #6B7280; font-size: 12px; font-style: italic;\">",
    "      <strong>Top SKU format:</strong> SKU Name | % of daily workspace spend",
    "    </p>",
    "  </div>",
    "  ",
    "  <div style=\"background-color: #F9F7F4; padding: 28px 24px;\">",
    "    <p style=\"margin: 0 0 18px 0; color: #1B3139; font-size: 14px; line-height: 1.5;\">Review the complete cost analysis and alert configuration:</p>",
    "    <a href=\"{{ALERT_URL}}\" style=\"display: inline-block; background-color: #FF3621; color: white; padding: 14px 32px; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 14px; letter-spacing: 0.3px;\">View Alert in Databricks</a>",
    "  </div>",
    "  ",
    "  <div style=\"margin: 24px; padding: 18px 22px; background-color: #FFF9E6; border-left: 4px solid #FFB020; border-radius: 4px;\">",
    "    <p style=\"margin: 0; color: #1B3139; font-size: 14px; line-height: 1.6;\"><strong style=\"font-weight: 600;\">Cost Alert:</strong> Your workspace spending has exceeded the configured threshold. The table above shows the highest-spending SKU for each workspace on each day. Review to identify optimization opportunities.</p>",
    "  </div>",
    "  ",
    "  <div style=\"padding: 24px; border-top: 1px solid #F9F7F4; background-color: white;\">",
    "    <p style=\"margin: 0; color: #6B7280; font-size: 12px; line-height: 1.7;\">",
    "      Databricks: 160 Spear Street, 15th Floor, San Francisco, CA 94105 USA<br>",
    "      © Databricks 2023. All rights reserved.",
    "    </p>",
    "  </div>",
    "</div>"
  ]
}
