{
  "custom_summary": "Databricks Alert - Cost Alert Triggered",
  "evaluation": {
    "source": {
      "name": "usage_date",
      "display": "usage_date",
      "aggregation": "AGGREGATION_UNSPECIFIED"
    },
    "comparison_operator": "IS_NOT_NULL",
    "threshold": {
      "value": {
        "string_value": ""
      }
    },
    "empty_result_state": "OK",
    "notification": {
      "retrigger_seconds": 1
    }
  },
  "schedule": {
    "quartz_cron_schedule": "22 0 8/12 * * ?",
    "timezone_id": "America/New_York"
  },
  "query_lines": [
    "with workspace as (",
    "  select distinct workspace_id",
    "  from system.billing.usage",
    "),",
    "-- filter usage for last 7 days",
    "usage_with_ws_filtered_by_date as (",
    "  select",
    "    concat('id: ', u.workspace_id) as workspace,",
    "    u.*",
    "  from system.billing.usage as u",
    "  left join workspace",
    "    on u.workspace_id = workspace.workspace_id",
    "  where u.usage_date between current_date() - interval 3 day and current_date()",
    "),",
    "-- join with prices in USD",
    "prices as (",
    "  select coalesce(price_end_time, date_add(current_date(), 1)) as coalesced_price_end_time, *",
    "  from system.billing.list_prices",
    "  where currency_code = 'USD'",
    "),",
    "list_priced_usd as (",
    "  select",
    "    workspace,",
    "    u.workspace_id,",
    "    u.billing_origin_product,",
    "    u.usage_date,",
    "    coalesce(u.usage_quantity * p.pricing.effective_list.default, 0) as usage_usd",
    "  from usage_with_ws_filtered_by_date as u",
    "  left join prices as p",
    "    on u.sku_name = p.sku_name",
    "    and u.usage_unit = p.usage_unit",
    "    and (u.usage_end_time between p.price_start_time and p.coalesced_price_end_time)",
    "),",
    "daily_workspace_product as (",
    "  select",
    "    usage_date,",
    "    workspace,",
    "    billing_origin_product,",
    "    sum(usage_usd) as total_usd_spend",
    "  from list_priced_usd",
    "  group by usage_date, workspace, billing_origin_product",
    "  having sum(usage_usd) > 5",
    "),",
    "daily_workspace_total as (",
    "  select",
    "    usage_date,",
    "    workspace,",
    "    sum(total_usd_spend) as workspace_total_usd",
    "  from daily_workspace_product",
    "  group by usage_date, workspace",
    "),",
    "ranked_products as (",
    "  select",
    "    dwp.usage_date,",
    "    dwp.workspace,",
    "    dwp.billing_origin_product,",
    "    dwp.total_usd_spend,",
    "    dwt.workspace_total_usd,",
    "    dwp.total_usd_spend / dwt.workspace_total_usd as percentage_usage,",
    "    row_number() over (partition by dwp.usage_date, dwp.workspace order by dwp.total_usd_spend desc) as rn",
    "  from daily_workspace_product dwp",
    "  join daily_workspace_total dwt",
    "    on dwp.usage_date = dwt.usage_date and dwp.workspace = dwt.workspace",
    ")",
    "select",
    "  usage_date,",
    "  workspace,",
    "  concat(billing_origin_product, ' | ', round(percentage_usage * 100, 0), '%') as top_sku_percentage_usage,",
    "  round(workspace_total_usd,0) as total_usd",
    "from ranked_products",
    "where rn = 1",
    "order by usage_date desc, workspace"
  ],
  "custom_description_lines": [
    "<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; background-color: #ffffff;\">",
    "  ",
    "  <!-- Header -->",
    "  <div style=\"background-color: #FF3621; color: white; padding: 20px 24px;\">",
    "    <h2 style=\"margin: 0; font-size: 20px; font-weight: 600;\">⚠️ Cost Threshold Alert Triggered</h2>",
    "  </div>",
    "  ",
    "  <!-- Alert Details -->",
    "  <div style=\"padding: 24px;\">",
    "    <h3 style=\"color: #1B3139; margin: 0 0 12px 0; font-size: 14px; font-weight: 600; text-transform: uppercase;\">Alert Details</h3>",
    "    <table style=\"width: 100%; border-collapse: collapse; margin-bottom: 24px;\">",
    "      <tr>",
    "        <td style=\"padding: 8px 0; font-weight: 600; width: 120px; color: #666666; font-size: 13px;\">Alert Name</td>",
    "        <td style=\"padding: 8px 0; color: #1B3139; font-size: 13px;\">{{ALERT_NAME}}</td>",
    "      </tr>",
    "      <tr>",
    "        <td style=\"padding: 8px 0; font-weight: 600; color: #666666; font-size: 13px;\">Status</td>",
    "        <td style=\"padding: 8px 0;\">",
    "          <span style=\"color: #FF3621; font-weight: 600; font-size: 14px;\">{{ALERT_STATUS}}</span>",
    "        </td>",
    "      </tr>",
    "      <tr>",
    "        <td style=\"padding: 8px 0; font-weight: 600; color: #666666; font-size: 13px;\">Condition</td>",
    "        <td style=\"padding: 8px 0; color: #1B3139; font-family: 'Courier New', monospace; font-size: 12px;\">{{ALERT_COLUMN}} {{ALERT_CONDITION}}</td>",
    "      </tr>",
    "    </table>",
    "    ",
    "    <!-- Cost Breakdown -->",
    "    <h3 style=\"color: #1B3139; margin: 24px 0 8px 0; font-size: 14px; font-weight: 600; text-transform: uppercase;\">Cost Breakdown (Last 3 Days)</h3>",
    "    <p style=\"margin: 0 0 12px 0; color: #666666; font-size: 12px;\">Top SKU per workspace per day (spend > $5)</p>",
    "    ",
    "    <table style=\"width: 100%; border-collapse: collapse; font-size: 13px; border: 1px solid #CCCCCC;\">",
    "      <thead>",
    "        <tr style=\"background-color: #F5F5F5;\">",
    "          <th style=\"padding: 10px 12px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #666666; border-bottom: 2px solid #CCCCCC;\">Date</th>",
    "          <th style=\"padding: 10px 12px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #666666; border-bottom: 2px solid #CCCCCC;\">Workspace</th>",
    "          <th style=\"padding: 10px 12px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #666666; border-bottom: 2px solid #CCCCCC;\">Top SKU</th>",
    "          <th style=\"padding: 10px 12px; text-align: right; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #666666; border-bottom: 2px solid #CCCCCC;\">Cost</th>",
    "        </tr>",
    "      </thead>",
    "      <tbody>",
    "        {{#QUERY_RESULT_ROWS}}",
    "        <tr>",
    "          <td style=\"padding: 10px 12px; color: #1B3139; font-size: 13px; border-bottom: 1px solid #EEEEEE;\">{{usage_date}}</td>",
    "          <td style=\"padding: 10px 12px; color: #1B3139; font-size: 12px; border-bottom: 1px solid #EEEEEE;\">{{workspace}}</td>",
    "          <td style=\"padding: 10px 12px; color: #666666; font-size: 12px; border-bottom: 1px solid #EEEEEE;\">{{top_sku_percentage_usage}}</td>",
    "          <td style=\"padding: 10px 12px; color: #FF3621; font-size: 14px; font-weight: 600; text-align: right; border-bottom: 1px solid #EEEEEE;\">${{total_usd}}</td>",
    "        </tr>",
    "        {{/QUERY_RESULT_ROWS}}",
    "      </tbody>",
    "    </table>",
    "    <p style=\"margin: 8px 0 0 0; color: #999999; font-size: 11px;\">",
    "      Format: SKU Name | % of daily workspace spend",
    "    </p>",
    "    ",
    "    <!-- CTA -->",
    "    <div style=\"margin: 24px 0;\">",
    "      <a href=\"{{ALERT_URL}}\" style=\"display: inline-block; background-color: #FF3621; color: white; padding: 12px 24px; text-decoration: none; font-weight: 600; font-size: 13px;\">View Alert in Databricks</a>",
    "    </div>",
    "    ",
    "    <!-- Warning -->",
    "    <div style=\"padding: 14px; background-color: #FFF9E6; border-left: 3px solid #FFB020; margin: 24px 0;\">",
    "      <p style=\"margin: 0; color: #1B3139; font-size: 13px; line-height: 1.5;\">Your workspace spending has exceeded the configured threshold. Review the breakdown above to identify optimization opportunities.</p>",
    "    </div>",
    "  </div>",
    "  ",
    "  <!-- Footer -->",
    "  <div style=\"padding: 16px 24px; border-top: 1px solid #DDDDDD; background-color: #F5F5F5;\">",
    "  </div>",
    "</div>"
  ]
}
